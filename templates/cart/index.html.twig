{% extends "layouts/_base.html.twig" %}

{% block title %}{{ config('app.name') }} - Cart{% endblock %}

{% block content %}
    <div class="cart-page">
        <div class="cart-page__content">
            <a href="/shop" class="btn btn-no-border">
                <span class="material-symbols-outlined">arrow_back</span>
                Continue Shopping
            </a>
            <div class="cart-page__content__block">
                <h1>Shopping Cart</h1>
                {% if cart|length > 0%}
                    {% set total = 0 %}
                    <div class="cart-container">
                        <div class="cart-card">
                            <div class="cart-card__header">
                                <div></div>
                                <div></div>
                                <div class="cart-card__header__title">Item</div>
                                <div class="cart-card__header__title">Quantity</div>
                                <div class="cart-card__header__title">Price</div>
                                <div class="cart-card__header__title">Subtotal</div>
                            </div>
                            {% for item in cart %}
                                <div class="cart-card__item">
                                    <div>
                                        <a href="#" class="delete" data-id="{{ item.id }}">
                                            <span class="material-symbols-outlined">close</span>
                                        </a>
                                    </div>
                                    <img src="{{ image(item.product.picture) }}" alt="{{ item.product.name }}">
                                    <div class="cart-card__item__name">{{ item.product.name }}</div>
                                    <div class="cart-card__item__quantity">
                                        <select name="quantity" id="quantity-{{ item.id }}" data-id="{{ item.id }}" style="width: 100%">
                                            <option value="1" {% if item.quantity == 1 %}selected{% endif %}>1</option>
                                            <option value="2" {% if item.quantity == 2 %}selected{% endif %}>2</option>
                                            <option value="3" {% if item.quantity == 3 %}selected{% endif %}>3</option>
                                            <option value="4" {% if item.quantity == 4 %}selected{% endif %}>4</option>
                                            <option value="5" {% if item.quantity == 5 %}selected{% endif %}>5</option>
                                        </select>
                                    </div>
                                    <div class="cart-card__item__price" id="item-price-{{ item.id }}" data-price="{{ item.product.price }}">${{ item.product.price|formatPrice }}</div>
                                    <div class="cart-card__item__total" id="item-total-{{ item.id }}" data-total="{{ item.product.price * item.quantity }}">${{ (item.product.price * item.quantity)|formatPrice }}</div>
                                </div>
                                {% set total = total + (item.product.price * item.quantity) %}
                            {% endfor %}
                        </div>
                        <div class="cart-summary">
                            <div class="cart-summary__title">Summary</div>
                            <div class="cart-summary__content">
                                <div class="cart-summary__content__line">
                                    <div class="title">Subtotal</div>
                                    <div class="value" id="summary-subtotal" data-subtotal="{{ total }}">${{ total|formatPrice }}</div>
                                </div>
                                <div class="cart-summary__content__line">
                                    <div class="title">Shipping</div>
                                    {% set shipping = 5000 %}
                                    {% if total > 15000 %}
                                        {% set shipping = 0 %}
                                    {% endif %}
                                    <div class="value" id="summary-shipping">${{ shipping|formatPrice }}</div>
                                </div>
                                <div class="cart-summary__total">
                                    <div class="title">Total</div>
                                    <div class="value" id="summary-total">${{ (total + shipping)|formatPrice }}</div>
                                </div>
                                <div class="cart-summary__footer">
                                    <input type="text" placeholder="Enter coupon code here">
                                    <button class="btn btn-primary">
                                        <span class="material-symbols-outlined">lock</span>
                                        Check Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="no-result">
                        <div class="no-result__content">
                            <div class="no-result__text">Your cart is empty</div>
                            <a href="/shop" class="btn btn-primary">Start Shopping</a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <script>
        document.querySelectorAll('select[name="quantity"]').forEach(quantity => {
            quantity.addEventListener('change', e => {
                let id = e.target.dataset.id
                let unitPrice = document.getElementById('item-price-' + id).dataset.price
                let total = (unitPrice * e.target.value) / 100
                
                document.getElementById('item-total-' + id).innerHTML = '$' + number_format(total, 2, '.', ',')
                document.getElementById('item-total-' + id).dataset.total = unitPrice * e.target.value

                let totalValue = 0

                document.querySelectorAll('.cart-card__item__total').forEach(totalItem => {
                    totalValue = totalValue + parseInt(totalItem.dataset.total)
                })

                document.getElementById('summary-subtotal').innerHTML = '$' + number_format((totalValue / 100), 2, '.', ',')

                let shipping = 5000
                if (totalValue > 15000) {
                    shipping = 0
                }

                document.getElementById('summary-shipping').innerHTML = '$' + number_format((shipping / 100), 2, '.', ',')
                document.getElementById('summary-total').innerHTML = '$' + number_format(((totalValue + shipping) / 100), 2, '.', ',')

                fetch ('/cart/update', {
                    method: 'POST',
                    body: JSON.stringify({
                        id: id,
                        quantity: e.target.value
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(() => {
                    let cartCount = 0

                    document.querySelectorAll('select[name="quantity"]').forEach(qty => {
                        cartCount += parseInt(qty.value)
                    })
                        
                    document.querySelector('.cart-count').innerHTML = cartCount
                })
            })
        })

        document.querySelectorAll('.delete').forEach(remove => {
            remove.addEventListener('click', e => {
                e.preventDefault()

                fetch ('/cart/delete', {
                    method: 'POST',
                    body: JSON.stringify({
                        id: e.target.closest('.delete').dataset.id
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(() => window.location.reload())
            })
        })

        function number_format(number, decimals, dec_point, thousands_sep) {
            number = (number + '').replace(/[^0-9+\-Ee.]/g, '')
            var n = !isFinite(+number) ? 0 : +number,
                prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
                sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,
                dec = (typeof dec_point === 'undefined') ? '.' : dec_point,
                s = '',
                toFixedFix = function (n, prec) {
                    var k = Math.pow(10, prec)
                    return '' + Math.round(n * k) / k
                }

            s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.')
            if (s[0].length > 3) {
                s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep)
            }
            if ((s[1] || '').length < prec) {
                s[1] = s[1] || ''
                s[1] += new Array(prec - s[1].length + 1).join('0')
            }
            return s.join(dec)
        }
    </script>
{% endblock %}